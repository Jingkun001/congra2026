<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨ - ä¸ªæ€§åŒ–æ–°å¹´ç¥ç¦è¯­ç”Ÿæˆå·¥å…·</title>
    
    <!-- SEO åŸºç¡€æ ‡ç­¾ -->
    <meta name="description" content="æ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨ - ä¸ªæ€§åŒ–æ–°å¹´ç¥ç¦è¯­ç”Ÿæˆå·¥å…·ã€‚è½»æ¾ç”Ÿæˆ10ç§é£æ ¼çš„ä¸“å±ç¥ç¦è¯­ï¼Œæ”¯æŒç”Ÿè‚–å¹´ä»½é€‰æ‹©ã€å¯¹è±¡å®šåˆ¶ã€å¤šæ ·åŒ–ä¸»é¢˜ã€‚">
    <meta name="keywords" content="ç¥ç¦è¯­,æ–°å¹´ç¥ç¦,æ˜¥èŠ‚ç¥ç¦,æ™ºèƒ½ç”Ÿæˆ,ç”Ÿè‚–,è´ºå²,ç¥ç¦">
    <meta name="author" content="MiniMax Agent">
    
    <!-- Open Graph æ ‡ç­¾ - ç”¨äºå¾®ä¿¡åˆ†äº« -->
    <meta property="og:title" content="æ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨ - ä¸ªæ€§åŒ–æ–°å¹´ç¥ç¦è¯­ç”Ÿæˆå·¥å…·">
    <meta property="og:description" content="è½»æ¾ç”Ÿæˆä¸“å±ç¥ç¦è¯­ï¼10ç§é£æ ¼ã€ç²¾å‡†åŒ¹é…ã€ç”Ÿè‚–å®šåˆ¶ï¼Œè®©æ‚¨çš„ç¥ç¦æ›´è´´å¿ƒã€‚">
    <meta property="og:image" content="https://example.com/imgs/share_card.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:url" content="">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="æ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨">
    
    <!-- Twitter Card æ ‡ç­¾ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="æ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨ - ä¸ªæ€§åŒ–æ–°å¹´ç¥ç¦è¯­ç”Ÿæˆå·¥å…·">
    <meta name="twitter:description" content="è½»æ¾ç”Ÿæˆä¸“å±ç¥ç¦è¯­ï¼10ç§é£æ ¼ã€ç²¾å‡†åŒ¹é…ã€ç”Ÿè‚–å®šåˆ¶ï¼Œè®©æ‚¨çš„ç¥ç¦æ›´è´´å¿ƒã€‚">
    <meta name="twitter:image" content="https://example.com/imgs/share_card.png">
    
    <!-- å¾®ä¿¡åˆ†äº«ç›¸å…³ -->
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #fef7f7 0%, #fdf2f8 50%, #fef2f2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* æ¸å˜èƒŒæ™¯ */
        .bg-gradient-gold {
            background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%);
        }
        .bg-gradient-red {
            background: linear-gradient(135deg, #C41E3A 0%, #8B0000 100%);
        }
        .bg-gradient-card {
            background: linear-gradient(145deg, #ffffff 0%, #fef2f2 100%);
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .fade-in-right {
            animation: fadeInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes fadeInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(196, 30, 58, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(196, 30, 58, 0); }
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .active-scale:active {
            transform: scale(0.95);
        }

        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #C41E3A;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .selected-card {
            border: 2px solid #C41E3A;
            background: linear-gradient(145deg, #fff1f2 0%, #fef2f2 100%);
            transform: scale(1.02);
        }

        /* ç”Ÿè‚–å›¾æ ‡åŠ¨ç”» */
        .zodiac-icon {
            transition: all 0.3s ease;
        }
        .zodiac-icon:hover {
            transform: scale(1.1) rotate(5deg);
        }

        /* ä¸»é¢˜æ ‡ç­¾åŠ¨ç”» */
        .theme-tag {
            transition: all 0.2s ease;
        }
        .theme-tag:hover {
            transform: translateY(-1px);
        }
        .theme-tag.selected {
            background: linear-gradient(135deg, #C41E3A 0%, #8B0000 100%);
            color: white;
            transform: scale(1.05);
        }

        /* Toast æ ·å¼ */
        .toast {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        /* ç»“æœå¡ç‰‡æ ·å¼ */
        .result-card {
            background: linear-gradient(145deg, #ffffff 0%, #fef7f7 100%);
            border: 1px solid rgba(196, 30, 58, 0.1);
            transition: all 0.3s ease;
        }
        .result-card:hover {
            border-color: rgba(196, 30, 58, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        /* åˆ†äº«æŒ‰é’®æ ·å¼ */
        .share-button {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        .share-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body class="text-gray-800 flex flex-col relative">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm border-b border-red-100">
        <div class="max-w-md mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-lg font-bold text-red-800 flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-red rounded-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                    </div>
                    æ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨
                </h1>
                <span id="step-indicator" class="text-xs font-semibold text-red-500 bg-red-50 px-3 py-1.5 rounded-full">Step 1/4</span>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div class="h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-gradient-red transition-all duration-700 ease-out" style="width: 25%"></div>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-1 max-w-md mx-auto w-full p-4 pb-24 overflow-y-auto no-scrollbar relative">
        
        <!-- Step 1: ç”Ÿè‚–å¹´ä»½é€‰æ‹© -->
        <section id="step-1" class="fade-in-right">
            <h2 class="text-xl font-bold text-gray-800 mb-1">è¯·é€‰æ‹©ç”Ÿè‚–å¹´ä»½</h2>
            <p class="text-sm text-gray-500 mb-6">é€‰æ‹©é©¬å¹´ï½çŒªå¹´ï¼Œå®šåˆ¶ä¸“å±å‰ç¥¥ç¥ç¦</p>
            
            <div class="grid grid-cols-3 gap-3" id="year-grid">
                <!-- ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>

        <!-- Step 2: ç¥ç¦å¯¹è±¡é€‰æ‹© -->
        <section id="step-2" class="hidden fade-in-right">
            <div class="flex items-center gap-2 mb-1">
                <button onclick="prevStep()" class="p-1 -ml-1 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold text-gray-800">å‘é€ç»™è°ï¼Ÿ</h2>
            </div>
            <p class="text-sm text-gray-500 mb-6">ä¸åŒèº«ä»½åŒ¹é…ä¸åŒè¯­æ°”çš„ç¥ç¦</p>

            <!-- å…³ç³»å¤§ç±» Tab -->
            <div class="flex bg-gray-100 rounded-xl p-1 mb-6 shadow-inner">
                <button onclick="switchRelationTab('work')" class="relation-tab flex-1 py-3 text-sm font-medium rounded-lg text-center transition-all bg-white text-red-600 shadow-sm" id="tab-work">èŒåœº</button>
                <button onclick="switchRelationTab('family')" class="relation-tab flex-1 py-3 text-sm font-medium rounded-lg text-center transition-all text-gray-500" id="tab-family">äº²å‹</button>
                <button onclick="switchRelationTab('business')" class="relation-tab flex-1 py-3 text-sm font-medium rounded-lg text-center transition-all text-gray-500" id="tab-business">å•†åŠ¡</button>
            </div>

            <!-- å­ç±»é€‰é¡¹ -->
            <div id="relation-subtypes" class="space-y-3">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>

        <!-- Step 3: ä¸»é¢˜ä¸ªæ€§åŒ– -->
        <section id="step-3" class="hidden fade-in-right">
            <div class="flex items-center gap-2 mb-1">
                <button onclick="prevStep()" class="p-1 -ml-1 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold text-gray-800">å®šåˆ¶ç»†èŠ‚</h2>
            </div>
            <p class="text-sm text-gray-500 mb-6">è®©ç¥ç¦æ›´å…·å¿ƒæ„</p>

            <div class="space-y-6">
                <!-- å¯¹æ–¹ç§°å‘¼ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¯¹æ–¹ç§°å‘¼ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="custom-name" placeholder="ä¾‹å¦‚ï¼šå¼ æ€»ã€ç‹å§¨ã€æé›·" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition-all bg-white shadow-sm">
                </div>

                <!-- ç¥ç¦ä¸»é¢˜ï¼ˆåŠ¨æ€ï¼‰ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">æ ¸å¿ƒç¥æ„¿ï¼ˆå¤šé€‰ï¼‰</label>
                    <div class="flex flex-wrap gap-2" id="theme-options">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æ•°é‡é€‰æ‹© -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">ç”Ÿæˆæ•°é‡</label>
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded-xl border border-gray-200">
                        <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white flex-1 justify-center transition-all">
                            <input type="radio" name="count" value="5" class="text-red-600 focus:ring-red-500" checked>
                            <span class="text-sm font-medium">5æ¡ ç²¾é€‰</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white flex-1 justify-center transition-all">
                            <input type="radio" name="count" value="10" class="text-red-600 focus:ring-red-500">
                            <span class="text-sm font-medium">10æ¡ ä¸°å¯Œ</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-lg hover:bg-white flex-1 justify-center transition-all">
                            <input type="radio" name="count" value="15" class="text-red-600 focus:ring-red-500">
                            <span class="text-sm font-medium">15æ¡ æµ·é‡</span>
                        </label>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 4: ç»“æœç”Ÿæˆ -->
        <section id="step-4" class="hidden fade-in-right pb-10">
            <!-- å¤´éƒ¨çŠ¶æ€ -->
            <div class="text-center mb-6" id="loading-state">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">AIæ­£åœ¨ä¸ºæ‚¨æ–Ÿé…Œè¯å¥...</p>
            </div>

            <div id="result-container" class="hidden space-y-4">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900">ç”Ÿæˆç»“æœ</h2>
                        <p class="text-xs text-gray-500 mt-1">ç‚¹å‡»å¡ç‰‡æˆ–æŒ‰é’®å³å¯å¤åˆ¶</p>
                    </div>
                    <button onclick="generateBlessings()" class="text-sm text-red-600 font-medium flex items-center gap-1 active-scale bg-red-50 px-3 py-1.5 rounded-full hover:bg-red-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        æ¢ä¸€æ‰¹
                    </button>
                </div>
                
                <div id="blessing-list" class="space-y-3">
                    <!-- åŠ¨æ€ç”Ÿæˆç»“æœå¡ç‰‡ -->
                </div>

                <div class="mt-8 flex gap-3">
                     <button onclick="restartSelection()" class="flex-1 py-3 border border-gray-300 rounded-xl text-gray-600 font-medium bg-white hover:bg-gray-50 transition-colors">
                        é‡æ–°é€‰æ‹©
                     </button>
                     <button onclick="generateBlessings()" class="flex-1 py-3 bg-red-600 text-white font-medium rounded-xl hover:bg-red-700 transition-colors">
                        æ¢ä¸€æ‰¹
                     </button>
                </div>

                <!-- åˆ†äº«æŒ‰é’®åŒºåŸŸ -->
                <div id="share-section" class="mt-6">
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-4 border border-green-200">
                        <div class="text-center">
                            <h3 class="text-sm font-medium text-gray-800 mb-2">åˆ†äº«ç»™æœ‹å‹</h3>
                            <button onclick="showShareMenu()" class="share-button text-white font-medium py-3 px-6 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 mx-auto">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                                </svg>
                                ç«‹å³åˆ†äº«
                            </button>
                            <p class="text-xs text-gray-500 mt-2">è®©æœ‹å‹ä»¬ä¹Ÿä½“éªŒæ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <footer id="action-bar" class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-200 p-4 max-w-md mx-auto z-40">
        <button id="next-btn" onclick="nextStep()" class="w-full bg-gradient-red text-white font-bold py-3.5 rounded-xl shadow-lg shadow-red-200 active:scale-95 transition-transform flex justify-center items-center gap-2 text-lg disabled:opacity-50 disabled:cursor-not-allowed">
            ä¸‹ä¸€æ­¥
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
        </button>
    </footer>

    <!-- Toast æç¤º -->
    <div id="toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 toast text-white px-6 py-3 rounded-full text-sm font-medium opacity-0 pointer-events-none transition-opacity duration-300 z-50 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span id="toast-msg">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</span>
    </div>

    <!-- è„šæœ¬é€»è¾‘ -->
    <script>
        // === æ•°æ®é…ç½® ===
        const YEARS = [
            { 
                year: 2026, 
                animal: 'é©¬', 
                icon: 'M6 12a6 6 0 016-6 6 6 0 016 6 6 6 0 01-6 6 6 6 0 01-6-6zm3-2l6 3-6 3-6-3 6-3zm-1 2l-5 3v6h16v-6l-5-3-1-1-5 3zm-4-1l1-1 5-3 5 3 1 1v2H9v-2z', 
                name: 'éªé©¬å¥”è…¾'
            },
            { 
                year: 2027, 
                animal: 'ç¾Š', 
                icon: 'M12 2C10.9 2 10 2.9 10 4C10 5.1 10.9 6 12 6C13.1 6 14 5.1 14 4C14 2.9 13.1 2 12 2ZM6 12a6 6 0 0112 0 6 6 0 01-12 0zm6-3c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm6 6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm0 3c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z', 
                name: 'ä¸‰ç¾Šå¼€æ³°'
            },
            { 
                year: 2028, 
                animal: 'çŒ´', 
                icon: 'M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7l-2-1c-2.4-1.2-5.2-1.2-7.6 0L10 8.6L7.6 6C5.2 4.8 2.4 4.8 0 6l-2 1v2l2 1c2.4 1.2 5.2 1.2 7.6 0L10 9.4L12.4 12c2.4 1.2 5.2 1.2 7.6 0l2-1V9z M8 15l2 1v2l-2-1v-2zm8 0l2 1v2l-2-1v-2z M16 7l-1-1-3 3-3-3-1 1 4 4 4-4z', 
                name: 'é‡‘çŒ´çŒ®ç‘'
            },
            { 
                year: 2029, 
                animal: 'é¸¡', 
                icon: 'M6 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm8-12V7c0-1.1-.9-2-2-2s-2 .9-2 2v0c0 1.1.9 2 2 2s2-.9 2-2zm0 8c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2s-2 .9-2 2v6c0 1.1.9 2 2 2zm6-4c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2s-2 .9-2 2v2c0 1.1.9 2 2 2zm0 2c1.1 0 2-.9 2-2v-2c0-1.1-.9-2-2-2s-2 .9-2 2v2c0 1.1.9 2 2 2z', 
                name: 'é‡‘é¸¡æŠ¥æ™“'
            },
            { 
                year: 2030, 
                animal: 'ç‹—', 
                icon: 'M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z M8 12a4 4 0 118 0 4 4 0 01-8 0zm6 2a2 2 0 100 4 2 2 0 000-4z', 
                name: 'ç‘çŠ¬é€ç¦'
            },
            { 
                year: 2031, 
                animal: 'çŒª', 
                icon: 'M12 2C13.1 2 14 2.9 14 4V6H10V4c0-1.1.9-2 2-2zm6 4v8a4 4 0 11-8 0V6h8zm-2 0H8V8a2 2 0 004 0V6zm-8 4v2a4 4 0 008 0v-2H8zm8 2v2a2 2 0 01-4 0v-2h4zm-6 0v2a6 6 0 0112 0v-2H10z', 
                name: 'é‡‘çŒªçº³ç¦'
            }
        ];

        const RELATIONS = {
            work: {
                label: 'èŒåœºå…³ç³»',
                subtypes: {
                    'ç›´å±é¢†å¯¼': { themes: ['æ­¥æ­¥é«˜å‡', 'é¢†å¯¼æœ‰æ–¹', 'å‡å®˜å‘è´¢', 'å‰é€”æ— é‡'], emoji: 'ğŸ‘‘ğŸ’¼ğŸ“ˆ' },
                    'å¤§è€æ¿': { themes: ['éªä¸šæ—¥æ–°', 'è´¢æºå¹¿è¿›', 'é¸¿å›¾å¤§å±•', 'ç”Ÿæ„å…´éš†'], emoji: 'ğŸ’ğŸ¢ğŸ’°' },
                    'åŒäº‹': { themes: ['å·¥ä½œé¡ºåˆ©', 'å›¢é˜Ÿå’Œè°', 'äº’ç›¸å¸®åŠ©', 'å…±åŒè¿›æ­¥'], emoji: 'ğŸ¤ğŸ’ªğŸ¯' },
                    'HR': { themes: ['æ‹›è˜é¡ºåˆ©', 'äººæ‰æµæµ', 'å›¢é˜Ÿå»ºè®¾', 'ä¼ä¸šæ–‡åŒ–'], emoji: 'ğŸ‘¥ğŸ“‹ğŸŒŸ' },
                    'é‡è¦å®¢æˆ·': { themes: ['åˆä½œæ„‰å¿«', 'äº’åˆ©å…±èµ¢', 'é•¿ä¹…åˆä½œ', 'æºæ‰‹å…±è¿›'], emoji: 'ğŸ¤ğŸ’¼ğŸ' }
                }
            },
            family: {
                label: 'äº²å‹å…³ç³»',
                subtypes: {
                    'çˆ¶æ¯': { themes: ['èº«ä½“å¥åº·', 'ä¸‡å¯¿æ— ç–†', 'ç¦å¦‚ä¸œæµ·', 'å¯¿æ¯”å—å±±'], emoji: 'ğŸµğŸ™ğŸ‹' },
                    'é•¿è¾ˆ': { themes: ['èº«ä½“å¥åº·', 'ç¦å¯¿åŒå…¨', 'é•¿å‘½ç™¾å²', 'å®¶æœ‰ä¸€å®'], emoji: 'ğŸ§¨ğŸ‘ğŸ’–' },
                    'å¹³è¾ˆäº²æˆš': { themes: ['å­¦ä¸šè¿›æ­¥', 'å§»ç¼˜ç¾æ»¡', 'æ—©ç”Ÿè´µå­', 'é˜–å®¶æ¬¢ä¹'], emoji: 'ğŸŠğŸ‰ğŸŒ¹' },
                    'å¥½å‹': { themes: ['å‹è°Šé•¿å­˜', 'å‰ç¨‹ä¼¼é”¦', 'å¿ƒæƒ³äº‹æˆ', 'å¿«ä¹æ¯ä¸€å¤©'], emoji: 'ğŸ’èµ›é›·ğŸ»ğŸ‰' },
                    'æ™šè¾ˆ': { themes: ['å­¦ä¸šè¿›æ­¥', 'å¥åº·æˆé•¿', 'å‰ç¨‹ä¼¼é”¦', 'é‡‘æ¦œé¢˜å'], emoji: 'ğŸ“ğŸŒŸğŸ’ª' }
                }
            },
            business: {
                label: 'å•†åŠ¡å…³ç³»',
                subtypes: {
                    'åˆä½œä¼™ä¼´': { themes: ['éªä¸šæ—¥æ–°', 'äº’åˆ©å…±èµ¢', 'è´¢æºæ»šæ»š', 'åˆä½œæ„‰å¿«'], emoji: 'â˜•ï¸ğŸ¤ğŸ’¼' },
                    'ä¾›åº”å•†': { themes: ['ç”Ÿæ„å…´éš†', 'ä¾›è´§é¡ºåˆ©', 'é•¿æœŸåˆä½œ', 'äº’åˆ©å…±èµ¢'], emoji: 'ğŸššğŸ“¦ğŸ¤' },
                    'æŠ•èµ„äºº': { themes: ['æŠ•èµ„æ”¶ç›Š', 'è´¢æºæ»šæ»š', 'äº‹ä¸šå‘å±•', 'å›æŠ¥ä¸°åš'], emoji: 'ğŸ’°ğŸ“ŠğŸš€' }
                }
            }
        };

        const STYLES = [
            { id: 1, name: 'ä¼ ç»Ÿå…¸é›…', desc: 'å››å­—æˆè¯­ï¼Œåº„é‡' },
            { id: 2, name: 'å¹½é»˜è½»æ¾', desc: 'ç½‘ç»œçƒ­æ¢—ï¼Œæœ‰è¶£' },
            { id: 3, name: 'æ¸©æƒ…èµ°å¿ƒ', desc: 'æƒ…æ„ŸçœŸæŒšï¼Œæ„Ÿäºº' },
            { id: 4, name: 'åŠ¡å®å¹²ç»ƒ', desc: 'ç®€çŸ­æœ‰åŠ›ï¼Œé«˜æ•ˆ' },
            { id: 5, name: 'åœ°åŸŸç‰¹è‰²', desc: 'æ°‘ä¿—é£å‘³' },
            { id: 6, name: 'æ–‡è‰ºå¤é£', desc: 'è¯—è¯æ­Œèµ‹' },
            { id: 7, name: 'å¯¹ä»—å·¥æ•´', desc: 'å¯¹è”å½¢å¼' },
            { id: 8, name: 'é¢œæ–‡å­—æ´¾', desc: 'å¯çˆ±ç¬¦å·' },
            { id: 9, name: 'èŒåœºä¸“ä¸š', desc: 'å±•æœ›æœªæ¥' },
            { id: 10, name: 'å®¶åº­æ¸©é¦¨', desc: 'å›¢åœ†å’Œç¦' }
        ];

        const ZODIAC_KEYWORDS = {
            'é©¬': { adj: 'é©¬åˆ°æˆåŠŸ', noun: 'éªé©¬', action: 'é©¬å¹´å¦‚æ„' },
            'ç¾Š': { adj: 'ä¸‰é˜³å¼€æ³°', noun: 'å‰ç¾Š', action: 'ç¾Šå¹´å¤§å‰' },
            'çŒ´': { adj: 'é‡‘çŒ´çŒ®ç‘', noun: 'çµçŒ´', action: 'çŒ´å¹´å¤§å‰' },
            'é¸¡': { adj: 'é‡‘é¸¡æŠ¥æ™“', noun: 'é›„é¸¡', action: 'é¸¡å¹´å¤§å‰' },
            'ç‹—': { adj: 'æ—ºæ—ºç”Ÿè´¢', noun: 'ç‘çŠ¬', action: 'ç‹—å¹´å¤§å‰' },
            'çŒª': { adj: 'è¯¸äº‹é¡ºåˆ©', noun: 'é‡‘çŒª', action: 'çŒªå¹´å¤§å‰' },
        };

        // === çŠ¶æ€ç®¡ç† ===
        let state = {
            step: 1,
            year: null,
            relationCat: 'work',
            relationSub: '',
            customName: '',
            themes: [],
            count: 5
        };

        // === åˆå§‹åŒ– ===
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            renderYearGrid();
            renderRelationSubtypes();
            renderThemes();
            updateUI();
            initShareConfig();
        });

        // === æ ¸å¿ƒé€»è¾‘å‡½æ•° ===

        // 1. æ¸²æŸ“å¹´ä»½ç½‘æ ¼
        function renderYearGrid() {
            const container = document.getElementById('year-grid');
            container.innerHTML = YEARS.map(y => `
                <div onclick="selectYear(${y.year})" 
                     class="cursor-pointer bg-gradient-card rounded-2xl p-4 shadow-lg border border-gray-100 flex flex-col items-center justify-center transition-all card-hover zodiac-icon ${state.year?.year === y.year ? 'selected-card' : ''}" 
                     data-year="${y.year}">
                    <div class="w-12 h-12 rounded-2xl bg-red-50 flex items-center justify-center mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="${y.icon}"/>
                        </svg>
                    </div>
                    <span class="font-bold text-base text-gray-800">${y.year}</span>
                    <span class="text-sm text-gray-500 font-medium">${y.animal}å¹´</span>
                    <span class="text-xs text-red-400 mt-1">${y.name}</span>
                </div>
            `).join('');
            validateStep();
        }

        // 2. é€‰æ‹©å¹´ä»½
        function selectYear(yearVal) {
            state.year = YEARS.find(y => y.year === yearVal);
            renderYearGrid();
            saveState();
            validateStep();
        }

        // 3. åˆ‡æ¢å…³ç³»Tab
        function switchRelationTab(cat) {
            state.relationCat = cat;
            state.relationSub = '';
            state.themes = [];
            
            // æ›´æ–°Tabæ ·å¼
            document.querySelectorAll('.relation-tab').forEach(el => {
                if(el.id === `tab-${cat}`) {
                    el.classList.remove('text-gray-500');
                    el.classList.add('bg-white', 'text-red-600', 'shadow-sm');
                } else {
                    el.classList.add('text-gray-500');
                    el.classList.remove('bg-white', 'text-red-600', 'shadow-sm');
                }
            });

            renderRelationSubtypes();
            renderThemes();
            validateStep();
        }

        // 4. æ¸²æŸ“å…³ç³»å­ç±»
        function renderRelationSubtypes() {
            const container = document.getElementById('relation-subtypes');
            const relations = RELATIONS[state.relationCat];
            const subtypes = Object.keys(relations.subtypes);
            
            container.innerHTML = subtypes.map(sub => `
                <div onclick="selectSubtype('${sub}')" 
                     class="w-full px-4 py-4 bg-white rounded-xl border text-left font-medium transition-all card-hover active:scale-[0.98] ${state.relationSub === sub ? 'border-red-500 bg-red-50 text-red-700 selected-card' : 'border-gray-200 text-gray-700 hover:border-red-200'}">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">${sub}</span>
                        ${state.relationSub === sub ? `
                        <svg class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>` : ''}
                    </div>
                </div>
            `).join('');
            validateStep();
        }

        function selectSubtype(sub) {
            state.relationSub = sub;
            renderRelationSubtypes();
            renderThemes();
            saveState();
            validateStep();
        }

        // 5. æ¸²æŸ“ä¸»é¢˜é€‰é¡¹
        function renderThemes() {
            const container = document.getElementById('theme-options');
            const relations = RELATIONS[state.relationCat];
            const subThemes = relations.subtypes[state.relationSub]?.themes || [];
            
            const currentThemes = state.themes || [];
            
            container.innerHTML = subThemes.map(theme => `
                <button onclick="toggleTheme('${theme}')" 
                        class="px-4 py-2 rounded-full text-sm border transition-all theme-tag ${currentThemes.includes(theme) ? 'selected' : 'bg-white border-gray-300 text-gray-600'}">
                    ${theme}
                </button>
            `).join('');
            validateStep();
        }

        function toggleTheme(theme) {
            if (state.themes.includes(theme)) {
                state.themes = state.themes.filter(t => t !== theme);
            } else {
                state.themes.push(theme);
            }
            renderThemes();
            saveState();
            validateStep();
        }

        // === å¯¼èˆªé€»è¾‘ ===
        function nextStep() {
            if (state.step < 4) {
                state.step++;
                if(state.step === 4) {
                    generateBlessings();
                }
                updateUI();
                saveState();
            }
        }

        function prevStep() {
            if (state.step > 1) {
                state.step--;
                updateUI();
                saveState();
            }
        }

        function updateUI() {
            const progress = state.step * 25;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('step-indicator').innerText = `Step ${state.step}/4`;

            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`step-${i}`);
                if (i === state.step) {
                    el.classList.remove('hidden');
                    el.classList.remove('fade-in-right');
                    void el.offsetWidth;
                    el.classList.add('fade-in-right');
                } else {
                    el.classList.add('hidden');
                }
            }

            const btn = document.getElementById('next-btn');
            if (state.step === 4) {
                document.getElementById('action-bar').classList.add('hidden');
            } else {
                document.getElementById('action-bar').classList.remove('hidden');
                validateStep();
            }
            
            if(state.step === 3) {
                document.getElementById('custom-name').value = state.customName;
            }
        }

        function validateStep() {
            const btn = document.getElementById('next-btn');
            let isValid = false;
            
            if (state.step === 1 && state.year) isValid = true;
            if (state.step === 2 && state.relationSub) isValid = true;
            if (state.step === 3) isValid = true;

            btn.disabled = !isValid;
            btn.innerHTML = state.step === 3 ? 
                `ç”Ÿæˆç¥ç¦ <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>` 
                : 
                `ä¸‹ä¸€æ­¥ <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>`;
        }

        // ä¿®å¤ï¼šå®Œå…¨é‡ç½®åº”ç”¨çŠ¶æ€å¹¶å›åˆ°é¦–é¡µ
        function resetApp() {
            localStorage.removeItem('blessingState');
            state = { step: 1, year: null, relationCat: 'work', relationSub: '', customName: '', themes: [], count: 5 };
            renderYearGrid();
            renderRelationSubtypes();
            renderThemes();
            updateUI();
        }

        // ä¿®å¤ï¼šé‡æ–°é€‰æ‹©åŠŸèƒ½ - æ¸…é™¤localStorageå¹¶å®Œå…¨é‡ç½®çŠ¶æ€
        function restartSelection() {
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('blessingState');
            // å®Œå…¨é‡ç½®çŠ¶æ€å¯¹è±¡
            state = { step: 1, year: null, relationCat: 'work', relationSub: '', customName: '', themes: [], count: 5 };
            // é‡ç½®Tabæ ·å¼
            document.querySelectorAll('.relation-tab').forEach(el => {
                el.classList.remove('bg-white', 'text-red-600', 'shadow-sm');
                el.classList.add('text-gray-500');
            });
            document.getElementById('tab-work').classList.add('bg-white', 'text-red-600', 'shadow-sm');
            document.getElementById('tab-work').classList.remove('text-gray-500');
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰å†…å®¹
            renderYearGrid();
            renderRelationSubtypes();
            renderThemes();
            updateUI();
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('custom-name').value = '';
            // é‡ç½®æ•°é‡é€‰æ‹©
            document.querySelector('input[name="count"][value="5"]').checked = true;
        }

        // === æ ¸å¿ƒç”Ÿæˆé€»è¾‘ ===
        function generateBlessings() {
            state.customName = document.getElementById('custom-name').value.trim();
            const countRadio = document.querySelector('input[name="count"]:checked');
            state.count = countRadio ? parseInt(countRadio.value) : 5;
            saveState();

            const loading = document.getElementById('loading-state');
            const result = document.getElementById('result-container');
            loading.classList.remove('hidden');
            result.classList.add('hidden');

            setTimeout(() => {
                const list = [];
                const styles = shuffleArray([...STYLES]);
                
                for (let i = 0; i < state.count; i++) {
                    const style = styles[i % styles.length];
                    list.push(createSingleBlessing(style));
                }

                renderResultList(list);
                loading.classList.add('hidden');
                result.classList.remove('hidden');
                result.classList.add('fade-in-right');
            }, 800);
        }

        function createSingleBlessing(style) {
            const zWord = ZODIAC_KEYWORDS[state.year.animal];
            const name = state.customName ? state.customName : getRelationAddress(state.relationSub);
            const theme = state.themes.length > 0 ? state.themes[Math.floor(Math.random() * state.themes.length)] : 'ä¸‡äº‹å¦‚æ„';
            const emojiSet = RELATIONS[state.relationCat].subtypes[state.relationSub]?.emoji || 'ğŸ‰ğŸŒŸğŸ’–';
            
            let text = "";

            switch (style.id) {
                case 1: // ä¼ ç»Ÿå…¸é›…
                    text = `${emojiSet} ${state.year.animal}å¹´ä¼Šå§‹ï¼Œä¸‡è±¡æ›´æ–°æ˜¥æ„æµ“ã€‚\n${zWord.noun}é€ç¦è‡³ï¼Œç‘æ°”ç›ˆé—¨å¥½è¿æ¥ã€‚\n${name}${theme}ï¼Œç¦æš–å››å­£é¡ºé‚å®‰åº·ï¼Œæ­¥æ­¥é«˜å‡å±•å®å›¾ï¼ ${emojiSet}`;
                    break;
                case 2: // å¹½é»˜è½»æ¾
                    text = `ğŸŠ æ–°å¹´æ–°æ°”è±¡ï¼Œ${state.year.year}å¹´åˆ°å•¦ï¼${emojiSet}\n${zWord.action}ï¼Œ${name}å¯è¦${theme}å“¦ï¼\nèŠéº»å¼€èŠ±èŠ‚èŠ‚é«˜ï¼Œå¼€å¿ƒå¿«ä¹æ¯ä¸€å¤©ï¼ğŸ’« æ„¿æ‰€æœ‰ç¾å¥½éƒ½å¦‚æœŸè€Œè‡³ï½ ${emojiSet}`;
                    break;
                case 3: // æ¸©æƒ…èµ°å¿ƒ
                    text = `${emojiSet} æ—¶å…‰èè‹’ï¼Œåˆæ˜¯ä¸€å¹´${state.year.animal}å¹´åˆ°ã€‚\n${name}ï¼Œæ„Ÿè°¢ä¸€è·¯ç›¸ä¼´ä¸é»˜é»˜æ”¯æŒã€‚\næ„¿æ–°çš„ä¸€å¹´${theme}ï¼Œå¹¸ç¦æ»¡æ»¡ï¼Œå¹³å®‰å¥åº·æ¯ä¸€å¤©ï¼\næ„¿æ‰€æœ‰çš„ç¾å¥½éƒ½ä¸ä½ ç›¸ä¼´å‰è¡Œï½ ${emojiSet}`;
                    break;
                case 4: // åŠ¡å®å¹²ç»ƒ
                    text = `ğŸ’¼ å€¼æ­¤${state.year.year}æ–°å¹´ä¹‹é™…ï¼Œ${zWord.adj}äº‹ä¸šå…´ã€‚\n${emojiSet} ${name}${theme}ï¼Œå·¥ä½œé«˜æ•ˆä¸šç»©ä½³ï¼\né¾™é©¬ç²¾ç¥å±•é›„å§¿ï¼Œå†åˆ›è¾‰ç…Œæ–°é«˜åº¦ï¼ ${emojiSet}`;
                    break;
                case 5: // åœ°åŸŸç‰¹è‰²
                    text = `ğŸ® ${state.year.animal}å¹´é”£é¼“å–§å¤©ï¼Œçº¢çº¢ç«ç«è¿æ–°æ˜¥ï¼\n${emojiSet} ${zWord.noun}é€ç¦åˆ°ï¼Œå¥½è¿è¿è¿ç»•èº«è¾¹ã€‚\n${name}${theme}ï¼Œæ—¥å­è¿‡å¾—çº¢çº¢ç«ç«ï¼Œå¦‚æ„å‰ç¥¥ä¹æ— è¾¹ï¼ ${emojiSet}`;
                    break;
                case 6: // æ–‡è‰ºå¤é£
                    text = `ğŸŒ¸ ${state.year.animal}å¹´æ˜¥æ„æµ“ï¼Œæ¢…å¼€äºŒåº¦æŠ¥æ–°æ˜¥ã€‚\nâœ¨ æµ…å–œè‹¥${theme}ï¼Œé™å¾…æ˜¥å½’å¥½æ—¶å…‰ã€‚\næ„¿${name}çœ‰ç›®èˆ’å±•å¿ƒè‡ªå®½ï¼Œ${zWord.action}ï¼Œ\nä¸è´ŸéŸ¶åä¸è´Ÿå¿ï¼Œå…±è°±äººç”Ÿæ–°åç« ï¼ ${emojiSet}`;
                    break;
                case 7: // å¯¹ä»—å·¥æ•´
                    text = `ğŸ“œ ä¸Šè”ï¼š${state.year.animal}å¹´${zWord.adj}è¿æ–°æ˜¥ï¼Œ\nğŸ® ä¸‹è”ï¼š${name}${theme}ä¸‡äº‹å…´ã€‚\nâœ¨ æ¨ªæ‰¹ï¼š${state.year.year}å¤§å‰å¤§åˆ©ï¼Œè¡Œè¿ä¸€æ¡é¾™ï¼ ${emojiSet}`;
                    break;
                case 8: // é¢œæ–‡å­—æ´¾
                    text = `( ^_^)ï¼ ${state.year.animal}å¹´åˆ°å•¦ï½ ${emojiSet}\nç¥${name}${theme}å“¦ â™ª( Â´Î¸ï½€)ãƒ\næ¯å¤©éƒ½è¦å¼€å¿ƒå¿«ä¹å‘€ï½ ${zWord.adj} â˜…\nå¿«ä¹åƒç³–æœä¸€æ ·ç”œç”œèœœèœœï½ ğŸ’• ${emojiSet}`;
                    break;
                case 9: // èŒåœºä¸“ä¸š
                    text = `ğŸ’ å€¼æ­¤${state.year.year}${state.year.animal}å¹´ä½³èŠ‚ï¼Œ${zWord.adj}å‰ç¨‹ä¼¼é”¦ã€‚\nğŸ¤ ${emojiSet} ${name}${theme}ï¼Œæºæ‰‹å…±è¿›åˆ›ä½³ç»©ï¼\né¾™è…¾è™è·ƒå±•é›„é£ï¼Œå…±é“¸è¾‰ç…Œæ–°ç¯‡ç« ï¼ ${emojiSet}`;
                    break;
                case 10: // å®¶åº­æ¸©é¦¨
                    text = `ğŸ  ${state.year.animal}å¹´åˆ°ï¼Œç¦æ°”ç…§ï¼Œå›¢åœ†ç¾æ»¡ä¹é€é¥ï¼\n${emojiSet} ${zWord.noun}è¿›é—¨å¥½ï¼Œ${name}${theme}å…¨å®¶å¥½ã€‚\nä¸€å®¶äººå’Œå’Œç¾ç¾ï¼Œå¹³å®‰å–œä¹ï¼Œç¬‘å£å¸¸å¼€ï¼\næ„¿çˆ±æ„æ»¡æ»¡ï¼Œæ¸©æš–å¦‚æ˜¥ï½ ${emojiSet}`;
                    break;
            }
            
            return { style: style.name, content: text };
        }

        function getRelationAddress(subtype) {
            const map = {
                'ç›´å±é¢†å¯¼': 'æ‚¨', 'å¤§è€æ¿': 'æ‚¨', 'åŒäº‹': 'åŒäº‹', 'HR': 'æ‚¨', 'é‡è¦å®¢æˆ·': 'æ‚¨',
                'çˆ¶æ¯': 'çˆ¸å¦ˆ', 'é•¿è¾ˆ': 'é•¿è¾ˆ', 'å¹³è¾ˆäº²æˆš': 'äº²äºº', 'å¥½å‹': 'å¥½å‹', 'æ™šè¾ˆ': 'å­©å­',
                'åˆä½œä¼™ä¼´': 'è´µæ–¹', 'ä¾›åº”å•†': 'è´µå¸', 'æŠ•èµ„äºº': 'æ‚¨'
            };
            return map[subtype] || 'æ‚¨';
        }

        function renderResultList(list) {
            const container = document.getElementById('blessing-list');
            container.innerHTML = list.map((item, index) => `
                <div class="result-card p-5 rounded-xl relative group cursor-pointer select-all" onclick="copyText(this, '${item.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-xs font-semibold text-red-500 bg-red-50 px-3 py-1 rounded-full">${item.style}</span>
                        <button onclick="event.stopPropagation(); copyText(this, '${item.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}')" class="text-gray-400 hover:text-red-600 transition-colors p-1 rounded-full hover:bg-red-50">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-gray-800 text-base leading-relaxed whitespace-pre-line pr-6">${item.content}</p>
                </div>
            `).join('');
        }

        // è¾…åŠ©å·¥å…·
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // å¤åˆ¶åŠŸèƒ½
        function copyText(element, text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast();
                const originalHTML = element.tagName === 'BUTTON' ? element.innerHTML : '';
                if(element.tagName === 'BUTTON') {
                    element.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
                    setTimeout(() => {
                        element.innerHTML = originalHTML;
                    }, 2000);
                }
            }).catch(err => {
                console.error('Copy failed', err);
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("Copy");
                textArea.remove();
                showToast();
            });
            
            console.log(`[åŸ‹ç‚¹] Copied blessing: ${text.substring(0, 15)}...`);
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'pointer-events-none');
            }, 2000);
        }

        // === å¾®ä¿¡åˆ†äº«åŠŸèƒ½ ===
        
        // åˆå§‹åŒ–åˆ†äº«é…ç½®
        function initShareConfig() {
            // è®¾ç½®åˆ†äº«URLï¼ˆå¦‚æœéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å®é™…URLï¼‰
            const currentUrl = window.location.href.split('#')[0];
            const ogMeta = document.querySelector('meta[property="og:url"]');
            if (ogMeta) {
                ogMeta.setAttribute('content', currentUrl);
            }
            
            // é…ç½®åˆ†äº«å†…å®¹
            const shareData = {
                title: 'æ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨ - ä¸ªæ€§åŒ–æ–°å¹´ç¥ç¦è¯­ç”Ÿæˆå·¥å…·',
                desc: 'è½»æ¾ç”Ÿæˆä¸“å±ç¥ç¦è¯­ï¼10ç§é£æ ¼ã€ç²¾å‡†åŒ¹é…ã€ç”Ÿè‚–å®šåˆ¶ï¼Œè®©æ‚¨çš„ç¥ç¦æ›´è´´å¿ƒã€‚',
                link: currentUrl,
                imgUrl: currentUrl.split('/').slice(0, -1).join('/') + '/imgs/share_card.png'
            };
            
            // å¾®ä¿¡ç¯å¢ƒæ£€æµ‹å’Œåˆ†äº«é…ç½®
            if (isWeChat()) {
                configureWeChatShare(shareData);
            }
        }

        // æ£€æµ‹æ˜¯å¦åœ¨å¾®ä¿¡ç¯å¢ƒä¸­
        function isWeChat() {
            const ua = navigator.userAgent.toLowerCase();
            return ua.indexOf('micromessenger') !== -1;
        }

        // é…ç½®å¾®ä¿¡åˆ†äº«
        function configureWeChatShare(shareData) {
            // è¿™é‡Œå¯ä»¥é›†æˆå¾®ä¿¡JSSDK
            // æ³¨æ„ï¼šéœ€è¦å¾®ä¿¡å¼€å‘è€…è´¦å·å’ŒJSSDKé…ç½®
            
            // æ¨¡æ‹Ÿå¾®ä¿¡åˆ†äº«åŠŸèƒ½
            if (typeof wx !== 'undefined') {
                wx.ready(() => {
                    // åˆ†äº«ç»™æœ‹å‹
                    wx.updateAppMessageShareData({
                        title: shareData.title,
                        desc: shareData.desc,
                        link: shareData.link,
                        imgUrl: shareData.imgUrl,
                        success: () => {
                            console.log('åˆ†äº«æˆåŠŸ');
                        },
                        cancel: () => {
                            console.log('åˆ†äº«å–æ¶ˆ');
                        }
                    });

                    // åˆ†äº«åˆ°æœ‹å‹åœˆ
                    wx.updateTimelineShareData({
                        title: shareData.title,
                        link: shareData.link,
                        imgUrl: shareData.imgUrl,
                        success: () => {
                            console.log('æœ‹å‹åœˆåˆ†äº«æˆåŠŸ');
                        },
                        cancel: () => {
                            console.log('æœ‹å‹åœˆåˆ†äº«å–æ¶ˆ');
                        }
                    });
                });
            }
        }

        // æ˜¾ç¤ºåˆ†äº«èœå•
        function showShareMenu() {
            const shareData = {
                title: 'æ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨ - ä¸ªæ€§åŒ–æ–°å¹´ç¥ç¦è¯­ç”Ÿæˆå·¥å…·',
                desc: 'è½»æ¾ç”Ÿæˆä¸“å±ç¥ç¦è¯­ï¼10ç§é£æ ¼ã€ç²¾å‡†åŒ¹é…ã€ç”Ÿè‚–å®šåˆ¶ï¼Œè®©æ‚¨çš„ç¥ç¦æ›´è´´å¿ƒã€‚',
                url: window.location.href.split('#')[0],
                image: 'imgs/share_card.png'
            };

            if (navigator.share) {
                // ä½¿ç”¨åŸç”Ÿåˆ†äº«API
                navigator.share({
                    title: shareData.title,
                    text: shareData.desc,
                    url: shareData.url
                }).then(() => {
                    showToast('åˆ†äº«æˆåŠŸï¼');
                }).catch((error) => {
                    console.log('åˆ†äº«å¤±è´¥:', error);
                    showCopyShareLink();
                });
            } else {
                showCopyShareLink();
            }
        }

        // æ˜¾ç¤ºå¤åˆ¶åˆ†äº«é“¾æ¥
        function showCopyShareLink() {
            const shareUrl = window.location.href.split('#')[0];
            const shareText = `æ™ºèƒ½ç¥ç¦ç”Ÿæˆå™¨ - ä¸ªæ€§åŒ–æ–°å¹´ç¥ç¦è¯­ç”Ÿæˆå·¥å…·\n${shareUrl}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                });
            } else {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = shareText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }
        }

        // LocalStorage ç®¡ç†
        function saveState() {
            try {
                localStorage.setItem('blessingState', JSON.stringify(state));
            } catch(e) {
                console.log('Storage failed');
            }
        }

        function loadState() {
            const saved = localStorage.getItem('blessingState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if(parsed.step) state.step = parsed.step;
                    if(parsed.year) state.year = parsed.year;
                    if(parsed.relationCat) state.relationCat = parsed.relationCat;
                    if(parsed.relationSub) state.relationSub = parsed.relationSub;
                    if(parsed.customName) state.customName = parsed.customName;
                    if(parsed.themes) state.themes = parsed.themes;
                    if(parsed.count) state.count = parsed.count;
                } catch(e) {
                    console.error('Load state failed', e);
                }
            }
        }

        // åŸ‹ç‚¹æ¨¡æ‹Ÿ
        window.addEventListener('beforeunload', () => {
            console.log(`[åŸ‹ç‚¹] User left at step ${state.step}`);
        });

    </script>
</body>
</html>
